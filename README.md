# Inventory-BW-sync
Скрипт синхронизации коллекций [Bitwarden](https://bitwarden.com/) (Вообще тестировалось только с [Vaultwarden](https://vaultwarden.net/)) со структурой сервисов Инвентаризации  
  
## Синхронизация Инвентаризация -> BW(VW)
  * Повторяет в VW структуру коллекций на основе дерева сервисов из [БД Инвентариацзии](https://github.com/spo0okie/arms_inventory)
  * Выдает на коллекцию права команде сопровождения соответствующего сервиса (ответственный + поддержка)
    * той части команды которая имеет учётки в BW(VW)
    * если состав команды изменяются - требует ручного подтверждения изменения прав на коллекцию (новые коллекции создает без запроса т.к. они изначально пусты)
    * если никого из состава команды сервиса нет в BW(VW) - коллекция не создается (технически не возможно)

## Требования
  * [Vaultwarden](https://github.com/dani-garcia/vaultwarden)
  * [Bitwarden CLI](https://bitwarden.com/help/cli/)
    * Для работы с self-hosted сервером с непубличным сертификатом нужен не бинарник, а установленный через NPM
   
## Инструкция
  * ```bash
    mkdir -p /opt/inventory-bw-sync
    cd /opt/inventory-bw-sync
    git clone https://github.com/spo0okie/inventory-bw-sync.git .
    mv config.priv.sample.php config.priv.php
    ```
  * настраиваем конфиг **config.priv.php**
    * пользователь для авторизации в Инвентаризации должен иметь права на чтение списка сервисов
    * пользователь для авторизации в BW(VW) должен иметь права на запись в корневой коллекции
      * Хэшированный пароль можно посмотреть через Chrome Developer Tools (F12) -> network -> запрос метода **token** -> поле **password**
  * в системе должны быть установлены сертификат CA выпустившего сертификат для self-hosted VW
    * Для debian должен присутствовать в /etc/ssl/certs/ca-certificates.crt
  * php ./sync.php

## Технические детали
Синхронизация папок (на самом деле это коллекции в терминологии VW)
  * Получаем список сервисов из инвентори
  * Обходим первый уровень дерева функцией parseService(serviceID)
    * Проверяем что в VW есть папка с ИД service#{serviceID} (создаем если нет)
    * Проверяем что ее полное имя совпадает с именем сервиса в инвентори с учетом имен родителей (в VW у всех коллекций полные имена, дерево VW выстраивает сам), при необходимости исправляем
    * Проверяем что ACL к ней повторяет список пользователей из команды сервиса, исправляем с подтверждением со стороны пользователя (y/n)
    * Обходим дочерние сервисы функцией parseService